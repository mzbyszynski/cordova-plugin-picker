module.exports = (function() {

  /**
   * Creates an instance of a Picker that encapsulates a set of options or choices and exposes methods of showing, hiding and
   * updating the list of choices and optional properties that function as callbacks for various events generated by the picker.
   *
   * @class Picker
   * @constructor
   */
  function Picker() {
    this._options = [];
  }

  var win = function(result) {
    console.log('win returned ' + result.event + ' with row ' + result.row + ' and component ' + result.component);
    if (result.event === 'close' || result.event === 'select') {
      //TODO: if this is done on select, does it need to be done on close as well? Select should have already been fired?
      var selected, oldValue;
      for (var i = 0; i < this._options.length; i++) {
        if (i === result.row) {
          selected = this._options[i];
          selected.selected = true;
        } else if (this._options[i].selected) {
          oldValue = this._options[i];
          oldValue.selected = false;
        }
      }
      if (result.event === 'close' && typeof this.onClose == 'function') 
        this.onHide(selected, oldValue);
      else if (result.event === 'select' && typeof this.onSelect == 'function') 
        this.onSelect(selected, oldValue);
    } else if (result.event === 'show' && typeof this.onShow == 'function')
      this.onShow();
    else if (result.event === 'change' && typeof this.onOptionsChange == 'function')
      this.onOptionsChange(this._options);
    else if (result.event === 'error' && typeof this.onError == 'function') 
      this.onError(result.error);
  };

  Picker.prototype = {

    /**
     * The name of the property on an option object that should be read to display 
     * 
     * @class Picker
     * @property optionTitle
     */
    optionTitle: "text",

    /**
     * @class Picker
     * @property options
     */
    get options() {
      return (this._options || []);
    },
    set options(newOptions) {
      this.update(newOptions || []);
    },

    /**
     * @class Picker
     * @method onShow
     */
    /**
     * @class Picker
     * @method onHide
     * @param {Object} newly selected option.
     * @param {Object} previously selection option.
     */ 
    /**
     * @class Picker
     * @method onOptionsChange
     */
    /**
     * @class Picker
     * @method onSelect
     * @param {Object} newly selected option.
     * @param {Object} previously selected option.
     */
    /**
     * Shows the picker if it not already visible and invokes the onShow function if it is defined on this Picker.
     * 
     * @class Picker
     * @method show
     */
    show: function() {
      console.log('showing picker');
      cordova.exec(win.bind(this), this.onError, 'Picker', 'show', [(this._options || []), this.optionTitle]);
    },

    /**
     * Hides this picker if is visible and invokes the onHide function if it is defined on this Picker.
     *
     * @class Picker
     * @method hide
     */
    hide: function() {
      cordova.exec(win.bind(this), this.onError, 'Picker', 'hide', []);
    },

    /**
     * updates the options exposed as choices in the picker and invokes the onOptionsChange callback if it is defined
     * on this Picker.
     * 
     * @class Picker
     * @method update
     * @param {Array} list of options to display in the picker.
     */
    update: function(newOptions) {
      this._options = newOptions;
      cordova.exec(win.bind(this), this.onError, 'Picker', 'updateOptions', [(this._options || [])]);
    }
  };

  /**
   * @class navigator.picker
   * @singleton
   */   
  return {
    echo: function(msg, success, failure) {
      console.log('Invoking CDVPicker.echo');
      cordova.exec(success, failure, 'Picker', 'echo', [msg]);
    },

    /**
     * @class navigator.picker
     * @method create
     */
    create: function() {
      return new Picker();
    }
  }
})();